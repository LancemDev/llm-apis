<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="../static/index.css">
</head>
<body>
    <div id="loading" class="spinner"></div>
    <div id="map" style="height: 1000px;"></div>
    
    <script>
        var map;
        var marker;
        var loading = document.getElementById('loading');

        function getLocation() {
            // Show the loading spinner
            loading.style.display = 'block';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log(pos);

                    // Initialize the map if it's not already initialized
                    if (!map) {
                        map = L.map('map').setView([pos.lat, pos.lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                        }).addTo(map);
                    } else {
                        // Update the map center
                        map.setView([pos.lat, pos.lng], 13);
                    }

                    // Remove the old marker if it exists
                    if (marker) {
                        map.removeLayer(marker);
                    }

                    // Add a new marker to the map at the current location
                    marker = L.marker([pos.lat, pos.lng]).addTo(map);

                    // Call the reverse geocoding API
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log(data.display_name);
                            // Hide the loading spinner
                            loading.style.display = 'none';
                        })
                        .catch(error => {
                            console.error(error);
                            // Hide the loading spinner
                            loading.style.display = 'none';
                        });
                }, function() {
                    handleLocationError(true, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                console.log("Your browser doesn't support geolocation.");
            }
        }

        function handleLocationError(browserHasGeolocation, pos) {
            console.log(browserHasGeolocation ?
                                                        'Error: The Geolocation service failed.' :
                                                        'Error: Your browser doesn\'t support geolocation.');
            // Hide the loading spinner
            loading.style.display = 'none';
        }

        // Get the location immediately when the page is loaded
        getLocation();

        // Update the location every 3 minutes
        setInterval(getLocation, 180000);
    </script>
</body>
</html>